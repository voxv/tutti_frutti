import{ProjectileTower as g}from"./ProjectileTower-opQaF9dn.js";import{P as u}from"./Projectile-BlnVoN5p.js";import"./index-D3WqjqW7.js";class x extends u{constructor({scene:i,x:t,y:o,target:e,damage:n,speed:s=420,direction:r={x:1,y:0},maxFruits:h=10}){super({position:{x:t,y:o},direction:{x:0,y:0},speed:0,damage:n,target:e,hitRadius:48}),this.sprite=i.add.sprite(t,o,"fire_anim"),this.sprite.setDisplaySize(70,95),this.sprite.setOrigin(.5,.5),this.sprite.setDepth(2e3),i.anims&&i.anims.exists("fire_anim")&&this.sprite.play("fire_anim"),this.sprite.projectileRef=this,this._hasHit=new Set,this.hasLanded=!0,this.fruitsHit=0,this.maxFruits=h}onHit(i){if(i&&typeof i.takeDamage=="function"&&!this._hasHit.has(i)&&this.fruitsHit<this.maxFruits){i.takeDamage(this.damage),this._hasHit.add(i);let t=1;i.nextTypes&&Array.isArray(i.nextTypes)&&(t+=i.nextTypes.length),this.fruitsHit+=t}}update(i){this.sprite&&(this.position.x=this.sprite.x,this.position.y=this.sprite.y)}destroy(){this.isActive=!1,this.sprite&&(this.sprite.destroy(),this.sprite=null)}}class d extends g{static placeOnScene(i,t,o){let e={};return i&&i.towerConfig&&i.towerConfig.fire&&(e={...i.towerConfig.fire}),new d(i,t,o,e)}constructor(i,t,o,e={}){super({position:{x:t,y:o},range:e.range||180,fireRate:e.fireRate||.3,damage:e.damage||2,cost:e.cost||420,type:e.type||"fire",towerType:e.towerType||"fire"}),this.scene=i,this.towerType=e.towerType||"fire",this.sprite=i.add.sprite(t,o,"fire"),this.sprite.setDisplaySize(80,80),this.sprite.setDepth(9e3),this.sprite.setOrigin(.5,.5),this.sprite.towerType=this.towerType,this.sprite.towerX=t,this.sprite.towerY=o,this._placedSprite=this.sprite,this.fireCooldown=0,this.lastShotTime=0,this.maxFruits=10}applyUpgrade(i){this.upgrades||(this.upgrades=[]),(i==="rapid_fire_1"||i==="rapid_fire_2"||i==="rapid_fire_3")&&(this.fireRate+=.1,this._placedSprite&&(this._placedSprite.towerFireRate=this.fireRate)),(i==="persistent_fire_1"||i==="persistent_fire_2"||i==="persistent_fire_3")&&(this.fireLifespan||(this.fireLifespan=this.scene&&this.scene.towerConfig&&this.scene.towerConfig.fire&&this.scene.towerConfig.fire.fireLifespan||1e3),this.fireLifespan+=300,this.maxFruits+=3,this._placedSprite&&(this._placedSprite.towerFireLifespan=this.fireLifespan),this._placedSprite&&(this._placedSprite.towerMaxFruits=this.maxFruits)),this.upgrades.push(i),window.sceneRef&&window.sceneRef.refreshUpgradeUIIfVisible&&window.sceneRef.refreshUpgradeUIIfVisible()}update(i,t,o){let e=o;if((!e||!Array.isArray(e)||e.length===0)&&this.scene&&this.scene.pathPoints&&(e=this.scene.pathPoints),this.fireCooldown&&this.fireCooldown>0&&(this.fireCooldown-=i),this.fireCooldown===void 0||this.fireCooldown===0||this.fireCooldown<=0){let n=[];if(t&&Array.isArray(t))for(const r of t)r&&r.isActive&&this.isInRange(r)&&n.push(r);if(n.length===0){super.update(i,t,o);return}let s=null;if(this.scene&&this.scene.spline){const r=[],p=this.range*.7;for(let a=0;a<=100;a++){const w=a/100,f=this.scene.spline.getPoint(w);if(!f)continue;const c=f.x-this.position.x,l=f.y-this.position.y;Math.sqrt(c*c+l*l)<=p&&r.push({x:f.x,y:f.y})}if(r.length>0){s=r[Math.floor(Math.random()*r.length)];const a=(Math.random()-.5)*12;s={x:s.x,y:s.y+a}}}if(!s&&n.length>0){let r=n[0],h=Math.sqrt(Math.pow(r.position.x-this.position.x,2)+Math.pow(r.position.y-this.position.y,2));for(const p of n){const a=Math.sqrt(Math.pow(p.position.x-this.position.x,2)+Math.pow(p.position.y-this.position.y,2));a<h&&(h=a,r=p)}s={x:r.position.x,y:r.position.y}}s&&(this.throwFire(s),this.fireCooldown=1/(this.fireRate||1))}super.update(i,t,o)}throwFire(i){const t=this.position.x,o=this.position.y,e=i.x,n=i.y,s=new x({scene:this.scene,x:t,y:o,target:i,damage:this.damage,maxFruits:this.maxFruits});this.scene.tweens.add({targets:s.sprite,x:e,y:n,duration:250,ease:"Quad.easeOut",onComplete:()=>{s.position.x=e,s.position.y=n;const r=this.fireLifespan||this.scene.towerConfig&&this.scene.towerConfig.fire&&this.scene.towerConfig.fire.fireLifespan||1e3;setTimeout(()=>{if(s.destroy(),this.scene.gameLogic.projectiles){const p=this.scene.gameLogic.projectiles.indexOf(s);p!==-1&&this.scene.gameLogic.projectiles.splice(p,1)}const h=this.projectiles.indexOf(s);h!==-1&&this.projectiles.splice(h,1)},r)}}),this.scene.gameLogic.projectiles||(this.scene.gameLogic.projectiles=[]),this.scene.gameLogic.projectiles.push(s),this.projectiles.push(s)}fire(i,t){}shootProjectile(i){}}export{d as FireTower};
