import{ProjectileTower as w}from"./ProjectileTower-kEcgx8fF.js";import"./index-CrztpCTk.js";class g extends w{applyUpgrade(e){console.log("[SpikeTower] applyUpgrade called:",{upgradeKey:e,pos:this.position,id:this._debugId,before:this._fatSpikes}),e==="bigger_range"?(this.range+=10,this._placedSprite&&this._placedSprite.towerRange!==void 0&&(this._placedSprite.towerRange=this.range)):e==="even_bigger_range"?(this.range+=10,this._placedSprite&&this._placedSprite.towerRange!==void 0&&(this._placedSprite.towerRange=this.range)):e==="more_spikes"?this._moreSpikes=!0:e==="faster_spikes"?this.fireRate+=.2:e==="super_fast_spikes"?this.fireRate+=.2:e==="fat_spikes"&&(this._fatSpikes=!0),this.upgrades=this.upgrades||[],this.upgrades.push(e),console.log("[SpikeTower] applyUpgrade finished:",{upgradeKey:e,pos:this.position,id:this._debugId,after:this._fatSpikes})}fire(e,r){}static placeOnScene(e,r,p){let o=110,n={};e&&e.towerConfig&&e.towerConfig.spike&&(n={...e.towerConfig.spike},e.towerConfig.spike.range&&(o=e.towerConfig.spike.range));const i=new g({position:{x:r,y:p},range:o,...n}),t=e.add.sprite(r,p,"spike_placed",0).setDisplaySize(64,64).setDepth(1001).setAlpha(1).setInteractive({useHandCursor:!0});return t.anims&&t.anims.stop(),t.setFrame(0),t.towerType="spike",t.towerX=r,t.towerY=p,t.towerRange=o,i._placedSprite=t,i.scene=e,i}constructor(e={}){super({...e,type:"projectile"}),this.lastSpikeTime=0,this.fireCooldown=0,this._spikeShootingDisabled=!0,this._fatSpikes=!1,this._debugId=Math.floor(Math.random()*1e6)}update(e,r,p){if(window._spikeDebugLog||(window._spikeDebugLog={frameCount:0}),window._spikeDebugLog.frameCount++,window._spikeDebugLog.frameCount%30===0&&console.log("[SpikeTower] DEBUG frame",window._spikeDebugLog.frameCount,"- _spikeShootingDisabled:",this._spikeShootingDisabled),this._spikeShootingDisabled)return;window._spikeDebugLog.enabled||(console.log("[SpikeTower] DEBUG: _spikeShootingDisabled is FALSE - shooting ENABLED!"),window._spikeDebugLog.enabled=!0);let o=p;if((!o||!Array.isArray(o)||o.length===0)&&this.scene&&this.scene.pathPoints&&(o=this.scene.pathPoints),!o||!Array.isArray(o)||o.length===0){window._spikeDebugLog.pathPoints===void 0&&(console.log("[SpikeTower] DEBUG: pathPoints missing or empty"),window._spikeDebugLog.pathPoints=!1);return}if(window._spikeDebugLog.pathPoints=!0,!this.scene||!this.scene.spline){window._spikeDebugLog.sceneSpline===void 0&&(console.log("[SpikeTower] DEBUG: scene or spline missing",{hasScene:!!this.scene,hasSpline:!!this.scene?.spline}),window._spikeDebugLog.sceneSpline=!1);return}if(window._spikeDebugLog.sceneSpline=!0,this.fireCooldown&&this.fireCooldown>0&&(this.fireCooldown-=e),(this.fireCooldown===void 0||this.fireCooldown===0||this.fireCooldown<=0)&&o&&o.length>0&&this.scene&&this.scene.spline){window._spikeDebugLog.cooldownReady===void 0&&(console.log("[SpikeTower] DEBUG: cooldown ready, about to throw spikes",{fireCooldown:this.fireCooldown}),window._spikeDebugLog.cooldownReady=!0);const n=[],i=100;for(let t=0;t<=i;t++){const a=t/i,s=this.scene.spline.getPoint(a);if(!s)continue;const d=s.x-this.position.x,f=s.y-this.position.y;Math.sqrt(d*d+f*f)<=this.range&&n.push({x:s.x,y:s.y})}if(n.length>0){const t=this._moreSpikes?2:1;for(let a=0;a<t;a++){let s=n[Math.floor(Math.random()*n.length)];const d=(Math.random()-.5)*12;if(s={x:s.x,y:s.y+d},this.scene&&this.scene.spikeProjectiles&&this.scene.spikeProjectiles.some(h=>{const l=h.x-s.x,c=h.y-s.y;return Math.sqrt(l*l+c*c)<4})){const h=Math.random()*2*Math.PI,l=6+Math.random()*4;s={x:s.x+Math.cos(h)*l,y:s.y+Math.sin(h)*l}}this.throwSpike(s)}if(this.lastSpikeTime=performance.now(),this.fireCooldown=1/(this.fireRate||1),this._placedSprite&&this._placedSprite.anims){const a="spike_tower_idle";this._placedSprite.anims&&this._placedSprite.anims.stop(),this._placedSprite.setFrame(0),this._placedSprite.play(a,!0);const s=this._placedSprite.anims.currentAnim?.frameRate?1e3/this._placedSprite.anims.currentAnim.frameRate*this._placedSprite.anims.currentAnim.frames.length:300;setTimeout(()=>{this._placedSprite&&this._placedSprite.anims&&this._placedSprite.anims.stop(),this._placedSprite&&this._placedSprite.setFrame&&this._placedSprite.setFrame(0)},s)}}}this.fireCooldown&&this.fireCooldown>0&&(this.fireCooldown-=e),super.update(e,r,p)}throwSpike(e){const r=this.position.x,p=this.position.y,o=e.x,n=e.y,i=this.scene.add.sprite(r,p,"spike_projectile");i.setDepth(2e3);const t=this._fatSpikes?47:24;i.setDisplaySize(t,t),this._fatSpikes&&i.setTint(16711935),i.damage=this.damage,i.active=!1,i.hitRadius=t,i._hasHit=new Set,this._fatSpikes&&(i.remainingPops=2),this.scene.tweens.add({targets:i,x:o,y:n,duration:250,ease:"Quad.easeOut",onComplete:()=>{i.active=!0,this.scene.spikeProjectiles||(this.scene.spikeProjectiles=[]),this.scene.spikeProjectiles.push(i)}})}}export{g as SpikeTower};
