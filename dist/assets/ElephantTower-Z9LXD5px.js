import{ProjectileTower as d}from"./ProjectileTower-B5_ViH3l.js";import{P as m}from"./Projectile-BlnVoN5p.js";import"./index-DbEVSGOF.js";class f extends m{constructor(i={}){super(i),this.projectileType="tornado",this.homing=i.homing!==void 0?i.homing:!0,this.homingStrength=i.homingStrength||.1,this.sprite=null,this.maxHits=i.maxHits||1,this._hitEnemies=new Set,this._homingDisabled=!1,this._collisionDisabled=!1}update(i){this.isActive&&(!this._homingDisabled&&this.homing&&this._hitEnemies.size===0?super.update(i):(this.position.x+=this.direction.x*this.speed*i,this.position.y+=this.direction.y*this.speed*i,this.sprite&&(this.sprite.x=this.position.x,this.sprite.y=this.position.y),(this.position.x>1300||this.position.x<0)&&(this.isActive=!1,this.sprite&&(this.sprite.destroy(),this.sprite=null))),this.checkCollisions())}checkCollisions(){if(!this.sprite||!this.sprite.active||this._collisionDisabled)return;const i=typeof window<"u"?window.sceneRef:null,t=i&&i.gameLogic&&Array.isArray(i.gameLogic.enemies)?i.gameLogic.enemies:[];for(const e of t){if(!e||!e.isActive||!e.position||this._hitEnemies.has(e))continue;if(Math.hypot(e.position.x-this.sprite.x,e.position.y-this.sprite.y)<=(this.hitRadius||60)&&(this.onHit(e),this._hitEnemies.size>=this.maxHits)){this._collisionDisabled=!0;return}}}onHit(i){if(!(!i||this._hitEnemies.has(i)||this._collisionDisabled))if(this._hitEnemies.add(i),i&&typeof i.knockback=="function"&&i.knockback(.6,3),this._hitEnemies.size<this.maxHits){const t=typeof window<"u"?window.sceneRef:null,e=t&&t.gameLogic&&Array.isArray(t.gameLogic.enemies)?t.gameLogic.enemies:[];let s=null,n=1/0;for(const o of e){if(!o||!o.isActive||!o.position||this._hitEnemies.has(o))continue;const a=Math.hypot(o.position.x-this.position.x,o.position.y-this.position.y);a<n&&(n=a,s=o)}s?(this.target=s,this._homingDisabled=!1):this._homingDisabled=!0}else this._homingDisabled=!0}}class c extends d{constructor(i={}){super({...i,type:"elephant"}),this.displayName="Elephant Tower",this.towerType="elephant",this.class="ElephantTower",this.assets={shopImage:"/towers/elephant_shop.png",shopImageScale:.5,placedImage:"/towers/elephant_anim.png",animation:{key:"elephant_tower_anim",frameWidth:350,frameHeight:350,frames:{start:0,end:2},frameRate:8,repeat:-1},projectile:"/towers/projectiles/tornado_anim.png"},this.projectileTexture="tornado_anim",this.homing=!0}applyUpgrade(i){this.stormWindLevel||(this.stormWindLevel=0),i==="storm_wind1"?this.stormWindLevel=Math.max(this.stormWindLevel,1):i==="storm_wind2"?this.stormWindLevel=Math.max(this.stormWindLevel,2):i==="storm_wind3"&&(this.stormWindLevel=Math.max(this.stormWindLevel,3)),i==="bigger_range"||i==="even_bigger_range"||i==="world_wide_range"?(this.range+=i==="world_wide_range"?200:52,this._placedSprite&&this._placedSprite.towerRange!==void 0&&(this._placedSprite.towerRange=this.range)):i==="heavy_boulder"?this.damage+=2:i==="double_boulder"?this.projectilesPerShot=2:i==="rapid_stomp"&&(this.fireRate+=1,this._placedSprite&&this._placedSprite.towerFireRate!==void 0&&(this._placedSprite.towerFireRate=this.fireRate)),this.upgrades.push(i)}update(i,t){let e=Date.now()/1e3;!(t&&t.some(n=>n&&n.isActive&&this.isInRange(n)))&&this._placedSprite&&(this._placedSprite.anims&&this._placedSprite.anims.isPlaying&&this._placedSprite.anims.stop(),typeof this._placedSprite.setFrame=="function"&&this._placedSprite.setFrame(1)),this.fire(t,e)}fire(i,t){if(this.acquireTarget(i),this.target&&t-this.lastShotTime>=1/this.fireRate){this.lastShotTime=t,this._placedSprite&&this._placedSprite.anims&&this._placedSprite.anims.play("elephant_tower_anim",!0);const e=this.projectilesPerShot||1;for(let s=0;s<e;s++)this.spawnProjectile(this.target)}else this.target}isInRange(i){const t=i.position.x-this.position.x,e=i.position.y-this.position.y;return Math.sqrt(t*t+e*e)<=this.range}acquireTarget(i){return i&&i.length&&i.forEach((t,e)=>{t&&t.position&&(t.position.x-this.position.x,t.position.y-this.position.y)}),super.acquireTarget(i)}spawnProjectile(i){if(!window.sceneRef)return;const t={speed:400,sprite:"tornado_anim"};let e=1;this.stormWindLevel===3?e=5:this.stormWindLevel===2?e=4:this.stormWindLevel===1&&(e=3);const s={x:this.position.x,y:this.position.y};if(!i||!i.position)return;const n=i.position.x-s.x,o=i.position.y-s.y,a=Math.sqrt(n*n+o*o),p=a>0?{x:n/a,y:o/a}:{x:1,y:0},l=new f({position:{...s},direction:p,speed:t.speed,damage:this.damage,texture:this.projectileTexture,target:i,homing:this.homing,hitRadius:60,maxHits:e}),r=window.sceneRef.add.sprite(s.x,s.y,t.sprite);r.setDisplaySize(135*.5,134*.5),r.setDepth(3e3),r.setVisible(!0),l.sprite=r,window.sceneRef.anims&&!window.sceneRef.anims.exists("tornado_anim")&&window.sceneRef.anims.create({key:"tornado_anim",frames:window.sceneRef.anims.generateFrameNumbers("tornado_anim",{start:0,end:1}),frameRate:10,repeat:-1}),window.sceneRef.anims.exists("tornado_anim")&&r.play("tornado_anim"),window.sceneRef.gameLogic&&Array.isArray(window.sceneRef.gameLogic.projectiles)&&window.sceneRef.gameLogic.projectiles.push(l)}static placeOnScene(i,t,e){const s=i&&i.cache&&i.cache.json&&i.cache.json.get?i.cache.json.get("tower"):null;let n=140,o=1.2,a=2;s&&s.elephant&&(n=s.elephant.range||n,o=s.elephant.fireRate||o,a=s.elephant.damage||a);const p=new c({position:{x:t,y:e},range:n,fireRate:o,damage:a}),l=220/2,h=i.add.sprite(t,e,"elephant_placed").setDisplaySize(l*.75,100*.75).setDepth(8500).setAlpha(1).setInteractive({useHandCursor:!0});return h.towerType="elephant",h.towerX=t,h.towerY=e,h.towerRange=n,h.setFrame(1),p._placedSprite=h,p}}export{c as ElephantTower};
