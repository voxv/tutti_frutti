import{A as S,t as c}from"./index-DoLVnJHs.js";class d extends S{static debugSetFrame(t,i,s){t&&typeof t.setFrame=="function"&&t.setFrame(i)}applyUpgrade(t){if(t==="penetration_2"&&this._laserSprite){const i=this._laserSprite.displayWidth,s=this._laserSprite.displayHeight;this._laserSprite.setDisplaySize(i+15,s+15)}if(t==="bigger_range"||t==="even_bigger_range"){if(this.range+=17,this._placedSprite&&this._placedSprite.towerRange!==void 0&&(this._placedSprite.towerRange=this.range),this._laserSprite){const i=this._laserSprite.displayWidth,s=this._laserSprite.displayHeight;this._laserSprite.setDisplaySize(i+10,s+10)}window.sceneRef&&window.sceneRef.refreshUpgradeUIIfVisible&&window.sceneRef.refreshUpgradeUIIfVisible()}else if(t==="world_wide_range")this.range+=100,this._placedSprite&&this._placedSprite.towerRange!==void 0&&(this._placedSprite.towerRange=this.range),window.sceneRef&&window.sceneRef.refreshUpgradeUIIfVisible&&window.sceneRef.refreshUpgradeUIIfVisible();else if(t==="attack_speed_1"){if(this.fireRate+=15,this._laserSprite&&this._laserSprite.anims&&this._laserSprite.anims.currentAnim){const i=this._laserSprite.anims.currentAnim;i&&typeof i.frameRate=="number"&&(i.frameRate+=5)}this._placedSprite&&this._placedSprite.towerFireRate!==void 0&&(this._placedSprite.towerFireRate=this.fireRate)}this.upgrades||(this.upgrades=[]),this.upgrades.push(t)}update(t,i){const s=i.filter(e=>e&&e.isActive&&this.isInRange(e));if(this._laserSprite){this._laserSprite.x=this.position.x+this.laserOffsetX,this._laserSprite.y=this.position.y+this.laserOffsetY;const e=performance.now();s.length>0?(this._lastLaserActiveTime=e,this._laserSprite.visible||this._laserSprite.setVisible(!0),this._laserSprite.anims.isPlaying||this._laserSprite.play("laser_shooter_anim",!0),this._placedSprite&&this._placedSprite.anims&&(!this._placedSprite.anims.isPlaying||this._placedSprite.anims.currentAnim?.key!=="laser_tower_idle")&&typeof this._placedSprite.play=="function"&&this._placedSprite.play("laser_tower_idle"),window.sceneRef&&window.sceneRef.sound&&window.sceneRef.sound.play&&e-this._lastBzzTime>2e3&&(window.sceneRef.sound.play("bzz"),this._lastBzzTime=e),this._laserBeamShouldBeVisible=!0):(this._lastLaserActiveTime||(this._lastLaserActiveTime=e),e-this._lastLaserActiveTime>250&&(d.debugSetFrame(this._laserSprite,0,"laser_shooter_anim stopped"),this._laserSprite.setVisible(!1),this._placedSprite&&this._placedSprite.anims&&(this._placedSprite.anims.isPlaying&&this._placedSprite.anims.stop(),this._placedSprite.setFrame(0),d.debugSetFrame(this._placedSprite,0,"placedSprite anim stopped")),this._laserBeamShouldBeVisible=!1))}for(const e of s)if(!(e._laserSpawnCooldownUntil&&performance.now()<e._laserSpawnCooldownUntil)&&(!e._lastLaserHitTime||performance.now()-e._lastLaserHitTime>200)){let l=this.damage;(e.constructor&&e.constructor.name==="BossBloon"||e.type==="boss")&&(l=Math.round(this.damage*4));let _=e.isActive;if(e.health-l<=0){this.upgrades&&(e._laserTowerUpgrades=Array.isArray(this.upgrades)?[...this.upgrades]:[]);const f=this.upgrades&&this.upgrades.includes("penetration"),p=this.upgrades&&this.upgrades.includes("penetration_2");e.takeDamage("LASER_KILL"),(f||p)&&window.sceneRef&&window.sceneRef.gameLogic&&Array.isArray(window.sceneRef.gameLogic.enemies)&&setTimeout(()=>{function a(o,g=[]){let m=0;const u=10,w=()=>{const h=window.sceneRef.gameLogic.enemies.filter(r=>r&&r.isActive&&r.constructor&&r.constructor.name.toLowerCase().includes(o.toLowerCase())&&r.position&&e.position&&r.position.x===e.position.x&&r.position.y===e.position.y&&!g.includes(r));h.length>0&&typeof h[0].takeDamage=="function"?h[0].takeDamage("LASER_KILL"):m<u&&(m++,setTimeout(w,30))};w()}e.nextTypes.length>0&&a(e.nextTypes[0]),p&&e.nextTypes.length>1&&setTimeout(()=>{a(e.nextTypes[1])},60)},60)}else e.takeDamage(l);_&&!e.isActive&&typeof e.reward=="number"&&window.sceneRef&&(window.sceneRef.goldAmount+=e.reward,window.sceneRef.goldText&&window.sceneRef.goldText.setText(String(window.sceneRef.goldAmount))),e._lastLaserHitTime=performance.now()}super.update(t,i)}constructor(t={}){let i={range:200,fireRate:3,damage:3,cost:350,type:"aoe"};c&&c.laser&&(i={...i,...c.laser}),super({...i,...t,type:"aoe"}),this._lastBzzTime=0,this._laserBeamShouldBeVisible=!0}static placeOnScene(t,i,s){let e=100;t&&t.towerConfig&&t.towerConfig.laser&&t.towerConfig.laser.range&&(e=t.towerConfig.laser.range);const n=t.add.sprite(i,s,"laser_placed",0).setDisplaySize(351*.19,248*.19).setDepth(8500).setAlpha(1).setInteractive({useHandCursor:!0});n.setFrame(0),n.towerType="laser",n.towerX=i,n.towerY=s,n.towerRange=e;const f=10,p=-10,a=t.add.sprite(i+f,s+p,"laser_anim");a.setDisplaySize(120,120),a.setDepth(3001),a.setRotation(Math.PI),a.play("laser_shooter_anim",!0),a.setVisible(!1);const o=new d({position:{x:i,y:s},range:e});return o._placedSprite=n,o.laserOffsetX=f,o.laserOffsetY=p,o._laserSprite=a,o}fire(t,i){}}export{d as LaserTower};
