import{A as g}from"./index-ChTLcBik.js";class S extends g{constructor(t={}){super(t),this.abductedFruits=[],this.fireRate=t.fireRate||1,this.abductCooldown=1/this.fireRate,this.abductTimer=0,this.pullSpeed=300,this.maxAbductions=1,this._lastOvniSoundTime=0}static placeOnScene(t,s,r){let a={};t&&t.towerConfig&&t.towerConfig.ovni&&(a={...t.towerConfig.ovni});const d=new S({...a,position:{x:s,y:r},type:"aoe",towerType:"ovni"});d.scene=t;const i=t.add.sprite(s,r,"ovni_anim");i.setDisplaySize(106*.06,106*.06),i.setDepth(9e3),i.setOrigin(.5,.5),i.towerType="ovni",i.towerX=s,i.towerY=r,i.towerRange=a.range||120,d._placedSprite=i;const o=t.add.sprite(s,r+25,"beam_anim");return o.setDisplaySize(45,45),o.setAlpha(.3),o.setDepth(8999),o.setOrigin(.5,0),o.setVisible(!1),d._beamSprite=o,i.anims&&i.anims.animationManager&&i.anims.animationManager.exists("ovni_idle")&&i.play("ovni_idle"),t.anims&&!t.anims.exists("beam_loop")&&t.anims.create({key:"beam_loop",frames:t.anims.generateFrameNumbers("beam_anim",{start:0,end:2}),frameRate:10,repeat:-1}),d}update(t,s){let r=Date.now()/1e3;if(this.fire(s,r),this.abductedFruits&&this.abductedFruits.length>0)for(let i=this.abductedFruits.length-1;i>=0;i--){const e=this.abductedFruits[i].fruit;if(!e.isActive){e.isAbducted=!1,this.abductedFruits.splice(i,1);continue}const n=this.position.x,h=this.position.y,c=n-e.position.x,f=Math.sign(c)*Math.min(Math.abs(c),this.pullSpeed*t);if(Math.abs(c)>1?e.position.x+=f:e.position.x=n,Math.abs(e.position.x-n)<2){const p=h-e.position.y,l=Math.sign(p)*Math.min(Math.abs(p),this.pullSpeed*t);Math.abs(p)>1?e.position.y+=l:e.position.y=h}e._sprite&&(e._sprite.x=e.position.x,e._sprite.y=e.position.y),Math.abs(e.position.x-n)<2&&Math.abs(e.position.y-h)<2&&(e.position.x=n,e.position.y=h,e._sprite&&(e._sprite.x=n,e._sprite.y=h),e.isActive=!1,e.isAbducted=!1,typeof window<"u"&&window.sceneRef&&typeof window.sceneRef.goldAmount=="number"&&!e._goldAwarded&&(window.sceneRef.goldAmount+=e.reward||0,window.sceneRef.goldText&&window.sceneRef.goldText.setText(String(window.sceneRef.goldAmount)),typeof window.sceneRef._refreshShopAvailability=="function"&&window.sceneRef._refreshShopAvailability(),typeof window.sceneRef.refreshUpgradeUIIfVisible=="function"&&window.sceneRef.refreshUpgradeUIIfVisible(),e._goldAwarded=!0),this.abductedFruits.splice(i,1))}let a=!1,d=[];if(s&&Array.isArray(s))for(const i of s)i&&i.isActive&&this.isInRange(i)&&(a=!0,d.push(i.position.y));if(a&&this.scene&&this.scene.sound){let i=r;this._ovniSoundInterval||(this._ovniSoundInterval=Math.random()*4+4),(!this._lastOvniSoundTime||i-this._lastOvniSoundTime>this._ovniSoundInterval)&&(this.scene.sound.play("ovni"),this._lastOvniSoundTime=i,this._ovniSoundInterval=Math.random()*4+4)}if(this._placedSprite&&this._placedSprite.anims){const i=this._placedSprite.anims,o=i.isPlaying&&i.currentAnim&&i.currentAnim.key==="ovni_idle";if(a){if(o||this._placedSprite.play("ovni_idle"),this._beamSprite){this._beamSprite.setVisible(!0);let e=null;if(this.scene&&this.scene.spline&&typeof this.scene.spline.getPoint=="function"){let p=1/0,l=null;const b=100;for(let u=0;u<=b;u++){const w=u/b,m=this.scene.spline.getPoint(w);if(!m)continue;const _=m.x-this.position.x;Math.abs(_)<p&&(p=Math.abs(_),l=m.y)}e=l}e!==null&&(this.position.y>e?(this._beamSprite.setScale(.4,-.4),this._beamSprite.setOrigin(.5,1),this._beamSprite.y=this.position.y-88):(this._beamSprite.setScale(.4,.4),this._beamSprite.setOrigin(.5,0),this._beamSprite.y=this.position.y+25));const n=this._beamSprite.anims,h=this._beamSprite.scene&&this._beamSprite.scene.anims,c=h&&h.exists&&h.exists("beam_loop"),f=this._beamSprite.texture&&this._beamSprite.texture.key&&this._beamSprite.texture.key!=="__MISSING";if(n&&c&&f)try{(!n.isPlaying||!n.currentAnim||n.currentAnim.key!=="beam_loop")&&this._beamSprite.play("beam_loop")}catch{}}}else o&&this._placedSprite.stop(),this._placedSprite.setFrame(0),this._beamSprite&&(this._beamSprite.setVisible(!1),this._beamSprite.stop())}}fire(t,s){if(this._lastAbductTime||(this._lastAbductTime=0),this.abductedFruits||(this.abductedFruits=[]),this.abductCooldown=1/this.fireRate,s-this._lastAbductTime<this.abductCooldown||!t||!Array.isArray(t)||this.abductedFruits.length>=this.maxAbductions)return;const r=new Set(this.abductedFruits.map(i=>i.fruit));let a=0;const d=Math.max(this.range,20+20*(this.maxAbductions-1));for(const i of t)if(!(i&&(i.type==="boss"||i.constructor?.name==="BossBloon"))&&!(i&&i._knockbackTimer&&i._knockbackTimer>0)&&i&&i.isActive&&this.isInRange(i)&&Math.abs(i.position.x-this.position.x)<d&&!r.has(i)&&(i.isAbducted=!0,this.abductedFruits.push({fruit:i,abductedX:i.position.x}),a++,a>=this.maxAbductions))break;a>0&&(this._lastAbductTime=s)}applyUpgrade(t){this.upgrades||(this.upgrades=[]),console.log("[OvniTower] applyUpgrade called:",t),(t==="faster_abduction_1"||t==="faster_abduction_2"||t==="faster_abduction_3")&&(this.fireRate+=.2,this.abductCooldown=1/this.fireRate,this._placedSprite&&(this._placedSprite.towerFireRate=this.fireRate)),t==="wider_beam_1"&&(this.maxAbductions=2),t==="wider_beam_2"&&(this.maxAbductions=3),t==="wider_beam_3"&&(this.maxAbductions=4),t==="alien_tech"&&(this.damage+=1,this._placedSprite&&(this._placedSprite.towerDamage=this.damage),console.log("[OvniTower] damage upgraded to",this.damage)),t==="galactic_power"&&(this.fireRate+=1,this.abductCooldown=1/this.fireRate,this.range+=50,this.damage+=2,this._placedSprite&&(this._placedSprite.towerFireRate=this.fireRate,this._placedSprite.towerRange=this.range,this._placedSprite.towerDamage=this.damage),console.log("[OvniTower] galactic_power applied:",this.fireRate,this.range,this.damage)),this.upgrades.push(t)}}export{S as OvniTower};
