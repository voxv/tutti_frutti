import{A as S,t as c}from"./index-RXehj8GH.js";class d extends S{static debugSetFrame(i,t,s){i&&typeof i.setFrame=="function"&&i.setFrame(t)}applyUpgrade(i){if(i==="penetration_2"&&this._laserSprite){const t=this._laserSprite.displayWidth,s=this._laserSprite.displayHeight;this._laserSprite.setDisplaySize(t+15,s+15)}if(i==="bigger_range"||i==="even_bigger_range"){if(this.range+=17,this._placedSprite&&this._placedSprite.towerRange!==void 0&&(this._placedSprite.towerRange=this.range),this._laserSprite){const t=this._laserSprite.displayWidth,s=this._laserSprite.displayHeight;this._laserSprite.setDisplaySize(t+10,s+10)}window.sceneRef&&window.sceneRef.refreshUpgradeUIIfVisible&&window.sceneRef.refreshUpgradeUIIfVisible()}else if(i==="world_wide_range")this.range+=100,this._placedSprite&&this._placedSprite.towerRange!==void 0&&(this._placedSprite.towerRange=this.range),window.sceneRef&&window.sceneRef.refreshUpgradeUIIfVisible&&window.sceneRef.refreshUpgradeUIIfVisible();else if(i==="attack_speed_1"){if(this.fireRate+=15,this._laserSprite&&this._laserSprite.anims&&this._laserSprite.anims.currentAnim){const t=this._laserSprite.anims.currentAnim;t&&typeof t.frameRate=="number"&&(t.frameRate+=5)}this._placedSprite&&this._placedSprite.towerFireRate!==void 0&&(this._placedSprite.towerFireRate=this.fireRate)}this.upgrades||(this.upgrades=[]),this.upgrades.push(i)}update(i,t){const s=t.filter(e=>e&&e.isActive&&this.isInRange(e));if(this._laserSprite){this._laserSprite.x=this.position.x+this.laserOffsetX,this._laserSprite.y=this.position.y+this.laserOffsetY;const e=performance.now();s.length>0?(this._lastLaserActiveTime=e,this._laserSprite.visible||this._laserSprite.setVisible(!0),this._laserSprite.anims.isPlaying||this._laserSprite.play("laser_shooter_anim",!0),this._placedSprite&&this._placedSprite.anims&&(!this._placedSprite.anims.isPlaying||this._placedSprite.anims.currentAnim?.key!=="laser_tower_idle")&&typeof this._placedSprite.play=="function"&&this._placedSprite.play("laser_tower_idle"),window.sceneRef&&window.sceneRef.sound&&window.sceneRef.sound.play&&e-this._lastBzzTime>2e3&&(window.sceneRef.sound.play("bzz"),this._lastBzzTime=e),this._laserBeamShouldBeVisible=!0):(this._lastLaserActiveTime||(this._lastLaserActiveTime=e),e-this._lastLaserActiveTime>250&&(d.debugSetFrame(this._laserSprite,0,"laser_shooter_anim stopped"),this._laserSprite.setVisible(!1),this._placedSprite&&this._placedSprite.anims&&(this._placedSprite.anims.isPlaying&&this._placedSprite.anims.stop(),this._placedSprite.setFrame(0),d.debugSetFrame(this._placedSprite,0,"placedSprite anim stopped")),this._laserBeamShouldBeVisible=!1))}for(const e of s)if(!(e._laserSpawnCooldownUntil&&performance.now()<e._laserSpawnCooldownUntil)&&(!e._lastLaserHitTime||performance.now()-e._lastLaserHitTime>200)){let l=this.damage;(e.constructor&&e.constructor.name==="BossBloon"||e.type==="boss")&&(l=Math.round(this.damage*2));let _=e.isActive;if(e.health-l<=0){this.upgrades&&(e._laserTowerUpgrades=Array.isArray(this.upgrades)?[...this.upgrades]:[]);const f=this.upgrades&&this.upgrades.includes("penetration"),p=this.upgrades&&this.upgrades.includes("penetration_2");e.takeDamage("LASER_KILL"),(f||p)&&window.sceneRef&&window.sceneRef.gameLogic&&Array.isArray(window.sceneRef.gameLogic.enemies)&&setTimeout(()=>{function r(o,w=[]){let m=0;const u=10,g=()=>{const h=window.sceneRef.gameLogic.enemies.filter(a=>a&&a.isActive&&a.constructor&&a.constructor.name.toLowerCase().includes(o.toLowerCase())&&a.position&&e.position&&a.position.x===e.position.x&&a.position.y===e.position.y&&!w.includes(a));h.length>0&&typeof h[0].takeDamage=="function"?h[0].takeDamage("LASER_KILL"):m<u&&(m++,setTimeout(g,30))};g()}e.nextTypes.length>0&&r(e.nextTypes[0]),p&&e.nextTypes.length>1&&setTimeout(()=>{r(e.nextTypes[1])},60)},60)}else e.takeDamage(l);_&&!e.isActive&&typeof e.reward=="number"&&window.sceneRef&&(window.sceneRef.goldAmount+=e.reward,window.sceneRef.goldText&&window.sceneRef.goldText.setText(String(window.sceneRef.goldAmount))),e._lastLaserHitTime=performance.now()}super.update(i,t)}constructor(i={}){let t={range:200,fireRate:3,damage:3,cost:350,type:"aoe"};c&&c.laser&&(t={...t,...c.laser}),super({...t,...i,type:"aoe"}),this._lastBzzTime=0,this._laserBeamShouldBeVisible=!0}static placeOnScene(i,t,s){let e=100;i&&i.towerConfig&&i.towerConfig.laser&&i.towerConfig.laser.range&&(e=i.towerConfig.laser.range);const n=i.add.sprite(t,s,"laser_placed",0).setDisplaySize(351*.19,248*.19).setDepth(8500).setAlpha(1).setInteractive({useHandCursor:!0});n.setFrame(0),n.towerType="laser",n.towerX=t,n.towerY=s,n.towerRange=e;const f=10,p=-10,r=i.add.sprite(t+f,s+p,"laser_anim");r.setDisplaySize(120,120),r.setDepth(3001),r.setRotation(Math.PI),r.play("laser_shooter_anim",!0),r.setVisible(!1);const o=new d({position:{x:t,y:s},range:e});return o._placedSprite=n,o.laserOffsetX=f,o.laserOffsetY=p,o._laserSprite=r,o}fire(i,t){}}export{d as LaserTower};
