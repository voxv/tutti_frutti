import{A as S}from"./index-Q2vFzrLS.js";class g extends S{constructor(t={}){super(t),this.abductedFruits=[],this.fireRate=t.fireRate||1,this.abductCooldown=1/this.fireRate,this.abductTimer=0,this.pullSpeed=300,this.maxAbductions=1}static placeOnScene(t,s,p){let o={};t&&t.towerConfig&&t.towerConfig.ovni&&(o={...t.towerConfig.ovni});const h=new g({...o,position:{x:s,y:p},type:"aoe",towerType:"ovni"});h.scene=t;const i=t.add.sprite(s,p,"ovni_anim");i.setDisplaySize(106*.06,106*.06),i.setDepth(9e3),i.setOrigin(.5,.5),i.towerType="ovni",i.towerX=s,i.towerY=p,i.towerRange=o.range||120,h._placedSprite=i;const n=t.add.sprite(s,p+25,"beam_anim");return n.setDisplaySize(45,45),n.setAlpha(.3),n.setDepth(8999),n.setOrigin(.5,0),n.setVisible(!1),h._beamSprite=n,i.anims&&i.anims.animationManager&&i.anims.animationManager.exists("ovni_idle")&&i.play("ovni_idle"),t.anims&&!t.anims.exists("beam_loop")&&t.anims.create({key:"beam_loop",frames:t.anims.generateFrameNumbers("beam_anim",{start:0,end:2}),frameRate:10,repeat:-1}),h}update(t,s){let p=Date.now()/1e3;if(this.fire(s,p),this.abductedFruits&&this.abductedFruits.length>0)for(let i=this.abductedFruits.length-1;i>=0;i--){const e=this.abductedFruits[i].fruit;if(!e.isActive){this.abductedFruits.splice(i,1);continue}const a=this.position.x,r=this.position.y,c=a-e.position.x,f=Math.sign(c)*Math.min(Math.abs(c),this.pullSpeed*t);if(Math.abs(c)>1?e.position.x+=f:e.position.x=a,Math.abs(e.position.x-a)<2){const d=r-e.position.y,l=Math.sign(d)*Math.min(Math.abs(d),this.pullSpeed*t);Math.abs(d)>1?e.position.y+=l:e.position.y=r}e._sprite&&(e._sprite.x=e.position.x,e._sprite.y=e.position.y),Math.abs(e.position.x-a)<2&&Math.abs(e.position.y-r)<2&&(e.position.x=a,e.position.y=r,e._sprite&&(e._sprite.x=a,e._sprite.y=r),e.isActive=!1,typeof window<"u"&&window.sceneRef&&typeof window.sceneRef.goldAmount=="number"&&!e._goldAwarded&&(window.sceneRef.goldAmount+=e.reward||0,window.sceneRef.goldText&&window.sceneRef.goldText.setText(String(window.sceneRef.goldAmount)),typeof window.sceneRef._refreshShopAvailability=="function"&&window.sceneRef._refreshShopAvailability(),typeof window.sceneRef.refreshUpgradeUIIfVisible=="function"&&window.sceneRef.refreshUpgradeUIIfVisible(),e._goldAwarded=!0),this.abductedFruits.splice(i,1))}let o=!1,h=[];if(s&&Array.isArray(s))for(const i of s)i&&i.isActive&&this.isInRange(i)&&(o=!0,h.push(i.position.y));if(this._placedSprite&&this._placedSprite.anims){const i=this._placedSprite.anims,n=i.isPlaying&&i.currentAnim&&i.currentAnim.key==="ovni_idle";if(o){if(n||this._placedSprite.play("ovni_idle"),this._beamSprite){this._beamSprite.setVisible(!0);let e=null;if(this.scene&&this.scene.spline&&typeof this.scene.spline.getPoint=="function"){let d=1/0,l=null;const b=100;for(let u=0;u<=b;u++){const w=u/b,m=this.scene.spline.getPoint(w);if(!m)continue;const _=m.x-this.position.x;Math.abs(_)<d&&(d=Math.abs(_),l=m.y)}e=l}e!==null&&(this.position.y>e?(this._beamSprite.setScale(.4,-.4),this._beamSprite.setOrigin(.5,1),this._beamSprite.y=this.position.y-88):(this._beamSprite.setScale(.4,.4),this._beamSprite.setOrigin(.5,0),this._beamSprite.y=this.position.y+25));const a=this._beamSprite.anims,r=this._beamSprite.scene&&this._beamSprite.scene.anims,c=r&&r.exists&&r.exists("beam_loop"),f=this._beamSprite.texture&&this._beamSprite.texture.key&&this._beamSprite.texture.key!=="__MISSING";if(a&&c&&f)try{(!a.isPlaying||!a.currentAnim||a.currentAnim.key!=="beam_loop")&&this._beamSprite.play("beam_loop")}catch{}}}else n&&this._placedSprite.stop(),this._placedSprite.setFrame(0),this._beamSprite&&(this._beamSprite.setVisible(!1),this._beamSprite.stop())}}fire(t,s){if(this._lastAbductTime||(this._lastAbductTime=0),this.abductedFruits||(this.abductedFruits=[]),this.abductCooldown=1/this.fireRate,s-this._lastAbductTime<this.abductCooldown||!t||!Array.isArray(t)||this.abductedFruits.length>=this.maxAbductions)return;const p=new Set(this.abductedFruits.map(i=>i.fruit));let o=0;const h=Math.max(this.range,20+20*(this.maxAbductions-1));for(const i of t)if(!(i&&(i.type==="boss"||i.constructor?.name==="BossBloon"))&&i&&i.isActive&&this.isInRange(i)&&Math.abs(i.position.x-this.position.x)<h&&!p.has(i)&&(i.isAbducted=!0,this.abductedFruits.push({fruit:i,abductedX:i.position.x}),o++,o>=this.maxAbductions))break;o>0&&(this._lastAbductTime=s)}applyUpgrade(t){this.upgrades||(this.upgrades=[]),console.log("[OvniTower] applyUpgrade called:",t),(t==="faster_abduction_1"||t==="faster_abduction_2"||t==="faster_abduction_3")&&(this.fireRate+=.2,this.abductCooldown=1/this.fireRate,this._placedSprite&&(this._placedSprite.towerFireRate=this.fireRate),console.log("[OvniTower] fireRate upgraded to",this.fireRate)),t==="wider_beam_1"&&(this.maxAbductions=2,console.log("[OvniTower] maxAbductions upgraded to 2")),t==="wider_beam_2"&&(this.maxAbductions=3,console.log("[OvniTower] maxAbductions upgraded to 3")),t==="wider_beam_3"&&(this.maxAbductions=4,console.log("[OvniTower] maxAbductions upgraded to 4")),t==="alien_tech"&&(this.damage+=1,this._placedSprite&&(this._placedSprite.towerDamage=this.damage),console.log("[OvniTower] damage upgraded to",this.damage)),t==="galactic_power"&&(this.fireRate+=1,this.abductCooldown=1/this.fireRate,this.range+=50,this.damage+=2,this._placedSprite&&(this._placedSprite.towerFireRate=this.fireRate,this._placedSprite.towerRange=this.range,this._placedSprite.towerDamage=this.damage),console.log("[OvniTower] galactic_power applied:",this.fireRate,this.range,this.damage)),this.upgrades.push(t)}}export{g as OvniTower};
