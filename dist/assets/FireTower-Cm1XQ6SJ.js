import{ProjectileTower as g}from"./ProjectileTower-DI7E01nS.js";import{P as u}from"./Projectile-BlnVoN5p.js";import"./index-Cno_qIZj.js";class x extends u{constructor({scene:i,x:s,y:o,target:t,damage:n,speed:e=420,direction:r={x:1,y:0},maxFruits:h=10}){super({position:{x:s,y:o},direction:{x:0,y:0},speed:0,damage:n,target:t,hitRadius:48}),this.sprite=i.add.sprite(s,o,"fire_anim"),this.sprite.setDisplaySize(70,95),this.sprite.setOrigin(.5,.5),this.sprite.setDepth(2e3),i.anims&&i.anims.exists("fire_anim")&&this.sprite.play("fire_anim"),this.sprite.projectileRef=this,this._hasHit=new Set,this.hasLanded=!0,this.fruitsHit=0,this.maxFruits=h}onHit(i){if(i&&typeof i.takeDamage=="function"&&!this._hasHit.has(i)&&this.fruitsHit<this.maxFruits){const o=i.type==="boss"||i.constructor?.name==="BossBloon"?this.damage*20:this.damage;i.takeDamage(o),this._hasHit.add(i);let t=1;i.nextTypes&&Array.isArray(i.nextTypes)&&(t+=i.nextTypes.length),this.fruitsHit+=t}}update(i){this.sprite&&(this.position.x=this.sprite.x,this.position.y=this.sprite.y)}destroy(){this.isActive=!1,this.sprite&&(this.sprite.destroy(),this.sprite=null)}}class d extends g{static placeOnScene(i,s,o){let t={};return i&&i.towerConfig&&i.towerConfig.fire&&(t={...i.towerConfig.fire}),new d(i,s,o,t)}constructor(i,s,o,t={}){super({position:{x:s,y:o},range:t.range||180,fireRate:t.fireRate||.3,damage:t.damage||2,cost:t.cost||420,type:t.type||"fire",towerType:t.towerType||"fire"}),this.scene=i,this.towerType=t.towerType||"fire",this.sprite=i.add.sprite(s,o,"fire"),this.sprite.setDisplaySize(80,80),this.sprite.setDepth(9e3),this.sprite.setOrigin(.5,.5),this.sprite.towerType=this.towerType,this.sprite.towerX=s,this.sprite.towerY=o,this._placedSprite=this.sprite,this.fireCooldown=0,this.lastShotTime=0,this.maxFruits=10}applyUpgrade(i){this.upgrades||(this.upgrades=[]),(i==="rapid_fire_1"||i==="rapid_fire_2"||i==="rapid_fire_3")&&(this.fireRate+=.1,this._placedSprite&&(this._placedSprite.towerFireRate=this.fireRate)),(i==="persistent_fire_1"||i==="persistent_fire_2"||i==="persistent_fire_3")&&(this.fireLifespan||(this.fireLifespan=this.scene&&this.scene.towerConfig&&this.scene.towerConfig.fire&&this.scene.towerConfig.fire.fireLifespan||1e3),this.fireLifespan+=300,this.maxFruits+=3,this._placedSprite&&(this._placedSprite.towerFireLifespan=this.fireLifespan),this._placedSprite&&(this._placedSprite.towerMaxFruits=this.maxFruits)),this.upgrades.push(i),window.sceneRef&&window.sceneRef.refreshUpgradeUIIfVisible&&window.sceneRef.refreshUpgradeUIIfVisible()}update(i,s,o){let t=o;if((!t||!Array.isArray(t)||t.length===0)&&this.scene&&this.scene.pathPoints&&(t=this.scene.pathPoints),this.fireCooldown&&this.fireCooldown>0&&(this.fireCooldown-=i),this.fireCooldown===void 0||this.fireCooldown===0||this.fireCooldown<=0){let n=[];if(s&&Array.isArray(s))for(const r of s)r&&r.isActive&&this.isInRange(r)&&n.push(r);if(n.length===0){super.update(i,s,o);return}let e=null;if(this.scene&&this.scene.spline){const r=[],p=this.range*.7;for(let a=0;a<=100;a++){const w=a/100,f=this.scene.spline.getPoint(w);if(!f)continue;const c=f.x-this.position.x,l=f.y-this.position.y;Math.sqrt(c*c+l*l)<=p&&r.push({x:f.x,y:f.y})}if(r.length>0){e=r[Math.floor(Math.random()*r.length)];const a=(Math.random()-.5)*12;e={x:e.x,y:e.y+a}}}if(!e&&n.length>0){let r=n[0],h=Math.sqrt(Math.pow(r.position.x-this.position.x,2)+Math.pow(r.position.y-this.position.y,2));for(const p of n){const a=Math.sqrt(Math.pow(p.position.x-this.position.x,2)+Math.pow(p.position.y-this.position.y,2));a<h&&(h=a,r=p)}e={x:r.position.x,y:r.position.y}}e&&(this.throwFire(e),this.fireCooldown=1/(this.fireRate||1))}super.update(i,s,o)}throwFire(i){const s=this.position.x,o=this.position.y,t=i.x,n=i.y,e=new x({scene:this.scene,x:s,y:o,target:i,damage:this.damage,maxFruits:this.maxFruits});this.scene.tweens.add({targets:e.sprite,x:t,y:n,duration:250,ease:"Quad.easeOut",onComplete:()=>{e.position.x=t,e.position.y=n;const r=this.fireLifespan||this.scene.towerConfig&&this.scene.towerConfig.fire&&this.scene.towerConfig.fire.fireLifespan||1e3;setTimeout(()=>{if(e.destroy(),this.scene.gameLogic.projectiles){const p=this.scene.gameLogic.projectiles.indexOf(e);p!==-1&&this.scene.gameLogic.projectiles.splice(p,1)}const h=this.projectiles.indexOf(e);h!==-1&&this.projectiles.splice(h,1)},r)}}),this.scene.gameLogic.projectiles||(this.scene.gameLogic.projectiles=[]),this.scene.gameLogic.projectiles.push(e),this.projectiles.push(e)}fire(i,s){}shootProjectile(i){}}export{d as FireTower};
