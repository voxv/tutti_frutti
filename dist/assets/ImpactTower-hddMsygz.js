import{A as d}from"./index-Dx5Ifr79.js";let m=1;class f extends d{constructor(e={}){const i={...{range:120,fireRate:1,damage:2,cost:500,type:"aoe",towerType:"impact"},...e};super(i),this.range=i.range||120,this.fireRate=i.fireRate||1,this.damage=i.damage||2,this.towerType="impact",this.maxBloonsPerAttack=1,this._attackState=null,this._attackStartTime=0,this._originalX=0,this._originalY=0,this._attackTarget=null,this._impactTowerId=m++}static placeOnScene(e,o,i){const n=e&&e.cache&&e.cache.json&&e.cache.json.get?e.cache.json.get("tower"):null;let c=120;n&&n.impact&&n.impact.range&&(c=n.impact.range);const s=e.add.sprite(o,i,"impact_placed",0).setDisplaySize(100*.7,100*.7).setDepth(8500).setAlpha(1).setInteractive({useHandCursor:!0});s.towerType="impact",s.towerX=o,s.towerY=i,s.towerRange=c;const t=new f({position:{x:o,y:i},range:c});return t.position={x:o,y:i},t.range=c,t.towerType="impact",t._placedSprite=s,t._originalX=o,t._originalY=i,s._parentTower=t,t}applyUpgrade(e){e==="bigger_impact"?this.maxBloonsPerAttack=3:e==="bigger_impact2"?this.maxBloonsPerAttack=4:e==="bigger_impact3"?this.maxBloonsPerAttack=5:e==="faster_impact"||e==="faster_impact2"||e==="faster_impact3"?(this.fireRate+=.9,this._placedSprite&&this._placedSprite.towerFireRate!==void 0&&(this._placedSprite.towerFireRate=this.fireRate)):e==="massive_impact"&&(this.damage+=2,this.range+=50,this._placedSprite&&this._placedSprite.towerRange!==void 0&&(this._placedSprite.towerRange=this.range)),this.upgrades||(this.upgrades=[]),this.upgrades.push(e)}update(e,o){if(this._attackState&&this._placedSprite){const i=performance.now()-this._attackStartTime,n=200,c=150,s=200,t=50;if(this._attackState==="runup"&&i<n&&this._attackTarget){const a=this._attackTarget.position.x-this._originalX,h=this._attackTarget.position.y-this._originalY,r=Math.sqrt(a*a+h*h),l=r>0?a/r:0,g=r>0?h/r:0,p=i/n;this._placedSprite.x=this._originalX-l*t*p,this._placedSprite.y=this._originalY-g*t*p}else if(this._attackState==="runup")this._attackState="charge",this._attackStartTime=performance.now();else if(this._attackState==="charge"&&i<c&&this._attackTarget){const a=this._attackTarget.position.x-this._originalX,h=this._attackTarget.position.y-this._originalY,r=Math.sqrt(a*a+h*h),l=r>0?a/r:0,g=r>0?h/r:0,p=i/c,_=40;this._placedSprite.x=this._originalX+l*_*p,this._placedSprite.y=this._originalY+g*_*p}else if(this._attackState==="charge")this._attackState="return",this._attackStartTime=performance.now();else if(this._attackState==="return"&&i<s){const a=i/s;this._placedSprite.x=this._originalX+(this._placedSprite.x-this._originalX)*(1-a),this._placedSprite.y=this._originalY+(this._placedSprite.y-this._originalY)*(1-a)}else this._attackState==="return"&&(this._placedSprite.x=this._originalX,this._placedSprite.y=this._originalY,this._attackState=null)}super.update(e,o)}fire(e,o){if(o-this.lastShotTime>=1/this.fireRate){this.lastShotTime=o;const i=[];for(const t of e)t.isActive&&this.isInRange(t)&&i.push(t);if(i.length===0)return;i.sort((t,a)=>{const h=Math.hypot(t.position.x-this.position.x,t.position.y-this.position.y),r=Math.hypot(a.position.x-this.position.x,a.position.y-this.position.y);return h-r});const n=i[0],c=this.maxBloonsPerAttack||1,s=i.slice(0,c);s.length>0&&(this._attackTarget=n,this._attackState="runup",this._attackStartTime=performance.now());for(const t of s)t.constructor&&t.constructor.name==="BossBloon"?t.takeDamage(this.damage*5):t.takeDamage(this.damage),!t.isActive&&!(t.isAtEnd&&t.isAtEnd())&&typeof window.sceneRef=="object"&&window.sceneRef&&(window.sceneRef.goldAmount+=t.reward,window.sceneRef.goldText&&window.sceneRef.goldText.setText(String(window.sceneRef.goldAmount)),typeof window.sceneRef._refreshShopAvailability=="function"&&window.sceneRef._refreshShopAvailability(),typeof window.sceneRef.refreshUpgradeUIIfVisible=="function"&&window.sceneRef.refreshUpgradeUIIfVisible())}}}export{f as ImpactTower};
