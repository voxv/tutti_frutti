import{A as f}from"./index-DYqfCKwm.js";let m=1;class d extends f{constructor(i={}){const e={...{range:120,fireRate:1,damage:2,cost:500,type:"aoe",towerType:"impact"},...i};super(e),this.range=e.range||120,this.fireRate=e.fireRate||1,this.damage=e.damage||2,this.towerType="impact",this.maxBloonsPerAttack=1,this._attackState=null,this._attackStartTime=0,this._originalX=0,this._originalY=0,this._attackTarget=null,this._impactTowerId=m++}static placeOnScene(i,o,e){const c=i&&i.cache&&i.cache.json&&i.cache.json.get?i.cache.json.get("tower"):null;let n=120;c&&c.impact&&c.impact.range&&(n=c.impact.range);const a=i.add.sprite(o,e,"impact_placed",0).setDisplaySize(100*.7,100*.7).setDepth(8500).setAlpha(1).setInteractive({useHandCursor:!0});a.towerType="impact",a.towerX=o,a.towerY=e,a.towerRange=n;const t=new d({position:{x:o,y:e},range:n});return t.position={x:o,y:e},t.range=n,t.towerType="impact",t._placedSprite=a,t._originalX=o,t._originalY=e,a._parentTower=t,t}applyUpgrade(i){console.log(`[ImpactTower] [ID ${this._impactTowerId}] Applying upgrade: ${i}, current maxBloonsPerAttack: ${this.maxBloonsPerAttack}`,this),i==="bigger_impact"?(this.maxBloonsPerAttack=2,console.log(`[ImpactTower] bigger_impact applied, maxBloonsPerAttack now: ${this.maxBloonsPerAttack}`)):i==="bigger_impact2"?(this.maxBloonsPerAttack=3,console.log(`[ImpactTower] bigger_impact2 applied, maxBloonsPerAttack now: ${this.maxBloonsPerAttack}`)):i==="bigger_impact3"?(this.maxBloonsPerAttack=4,console.log(`[ImpactTower] bigger_impact3 applied, maxBloonsPerAttack now: ${this.maxBloonsPerAttack}`)):i==="faster_impact"||i==="faster_impact2"||i==="faster_impact3"?(this.fireRate+=.5,console.log(`[ImpactTower] ${i} applied, fireRate now: ${this.fireRate}`),this._placedSprite&&this._placedSprite.towerFireRate!==void 0&&(this._placedSprite.towerFireRate=this.fireRate)):i==="massive_impact"&&(this.damage+=2,this.range+=50,this._placedSprite&&this._placedSprite.towerRange!==void 0&&(this._placedSprite.towerRange=this.range)),this.upgrades||(this.upgrades=[]),this.upgrades.push(i),console.log(`[ImpactTower] [ID ${this._impactTowerId}] Upgrades array after apply:`,this.upgrades,this)}update(i,o){if(this._attackState&&this._placedSprite){const e=performance.now()-this._attackStartTime,c=200,n=150,a=200,t=50;if(this._attackState==="runup"&&e<c&&this._attackTarget){const s=this._attackTarget.position.x-this._originalX,p=this._attackTarget.position.y-this._originalY,r=Math.sqrt(s*s+p*p),l=r>0?s/r:0,g=r>0?p/r:0,h=e/c;this._placedSprite.x=this._originalX-l*t*h,this._placedSprite.y=this._originalY-g*t*h}else if(this._attackState==="runup")this._attackState="charge",this._attackStartTime=performance.now();else if(this._attackState==="charge"&&e<n&&this._attackTarget){const s=this._attackTarget.position.x-this._originalX,p=this._attackTarget.position.y-this._originalY,r=Math.sqrt(s*s+p*p),l=r>0?s/r:0,g=r>0?p/r:0,h=e/n,_=40;this._placedSprite.x=this._originalX+l*_*h,this._placedSprite.y=this._originalY+g*_*h}else if(this._attackState==="charge")this._attackState="return",this._attackStartTime=performance.now();else if(this._attackState==="return"&&e<a){const s=e/a;this._placedSprite.x=this._originalX+(this._placedSprite.x-this._originalX)*(1-s),this._placedSprite.y=this._originalY+(this._placedSprite.y-this._originalY)*(1-s)}else this._attackState==="return"&&(this._placedSprite.x=this._originalX,this._placedSprite.y=this._originalY,this._attackState=null)}super.update(i,o)}fire(i,o){if(o-this.lastShotTime>=1/this.fireRate){this.lastShotTime=o;const e=[];for(const t of i)t.isActive&&this.isInRange(t)&&e.push(t);if(e.length===0)return;e.sort((t,s)=>{const p=Math.hypot(t.position.x-this.position.x,t.position.y-this.position.y),r=Math.hypot(s.position.x-this.position.x,s.position.y-this.position.y);return p-r});const c=e[0],n=this.maxBloonsPerAttack||1,a=e.slice(0,n);console.log(`[ImpactTower fire] [ID ${this._impactTowerId}] maxBloonsPerAttack=${n}, bloonsInRange=${e.length}, targetedEnemies=${a.length}`,this),a.length>0&&(this._attackTarget=c,this._attackState="runup",this._attackStartTime=performance.now());for(const t of a)t.constructor&&t.constructor.name==="BossBloon"?t.takeDamage(this.damage*5):t.takeDamage(this.damage),!t.isActive&&!(t.isAtEnd&&t.isAtEnd())&&typeof window.sceneRef=="object"&&window.sceneRef&&(window.sceneRef.goldAmount+=t.reward,window.sceneRef.goldText&&window.sceneRef.goldText.setText(String(window.sceneRef.goldAmount)),typeof window.sceneRef._refreshShopAvailability=="function"&&window.sceneRef._refreshShopAvailability(),typeof window.sceneRef.refreshUpgradeUIIfVisible=="function"&&window.sceneRef.refreshUpgradeUIIfVisible())}}}export{d as ImpactTower};
