import{ProjectileTower as u}from"./ProjectileTower-Dfz0UU9i.js";import{t as l}from"./index-CcSHno1z.js";import{p as m}from"./projectiles-CDq3D0-e.js";import{B as g}from"./BoulderProjectile-DaDxGvld.js";import"./Projectile-BlnVoN5p.js";class f extends u{constructor(e={}){let i={range:180,fireRate:1.2,damage:2,cost:280,type:"projectile",homing:!0};l&&l.sniper&&(i={...i,...l.sniper}),super({...i,...e,type:"projectile"}),this.projectileTexture="boulder",this.homing=e.homing!==void 0?e.homing:i.homing,this._pendingDrops=[]}applyUpgrade(e){e==="bigger_range"||e==="even_bigger_range"?(this.range+=52,this._placedSprite&&this._placedSprite.towerRange!==void 0&&(this._placedSprite.towerRange=this.range)):e==="extreme_range"?(this.range+=200,this._placedSprite&&this._placedSprite.towerRange!==void 0&&(this._placedSprite.towerRange=this.range)):e==="rapid_fire"?(this.fireRate+=.5,this._placedSprite&&this._placedSprite.towerFireRate!==void 0&&(this._placedSprite.towerFireRate=this.fireRate)):e==="piercing_shot"?this._piercingShot=!0:e==="headshot"&&(this.fireRate+=.5,this._headshot=!0,this._placedSprite&&this._placedSprite.towerFireRate!==void 0&&(this._placedSprite.towerFireRate=this.fireRate)),this.upgrades.push(e)}update(e,i){let r=Date.now()/1e3;!(i&&i.some(t=>t&&t.isActive&&this.isInRange(t)))&&this._placedSprite&&(this._placedSprite.anims&&this._placedSprite.anims.isPlaying&&this._placedSprite.anims.stop(),typeof this._placedSprite.setFrame=="function"&&this._placedSprite.setFrame(0)),this.fire(i,r)}static placeOnScene(e,i,r,n={}){let t=180;n&&n.sniper&&n.sniper.range&&(t=n.sniper.range);const s=new f({position:{x:i,y:r}}),a=e.add.sprite(i,r,"sniper_placed",0).setDisplaySize(280*.27,155*.45).setDepth(8500).setAlpha(1).setInteractive({useHandCursor:!0});return a.towerType="sniper",a.towerX=i,a.towerY=r,a.towerRange=t,s._placedSprite=a,s}fire(e,i){if(this.acquireTarget(e),this.target&&i-this.lastShotTime>=1/this.fireRate){this.lastShotTime=i,this._placedSprite&&this._placedSprite.anims&&this._placedSprite.anims.play("sniper_placed",!0);const r=m.boulder||{hitRadius:36},n={x:this.position.x,y:this.position.y-20},t={x:0,y:-1},s=new g({position:{...n},direction:t,speed:1300,damage:this.damage,texture:this.projectileTexture,target:null,hitRadius:r.hitRadius,homing:!1,maxHits:1,showExplosion:!1}),o=window.sceneRef.add.sprite(n.x,n.y,"sniper_projectile");o.setDisplaySize(13,13),o.setScale(.3),o.setFlipY(!0),o.setDepth(3001),s.sprite=o,this._scheduleDelayedDrop(s,e),this.projectiles.push(s),window.sceneRef&&window.sceneRef.gameLogic&&Array.isArray(window.sceneRef.gameLogic.projectiles)&&window.sceneRef.gameLogic.projectiles.push(s)}}_scheduleDelayedDrop(e,i){i&&[...i];const r=setInterval(()=>{if(!e.sprite||e.sprite.y<-50){clearInterval(r),e.sprite&&(e.sprite.destroy(),e.sprite=null),e.isActive=!1;const n=setTimeout(()=>{if(window.sceneRef&&window.sceneRef.gameLogic){const o=(window.sceneRef.gameLogic.enemies||[]).filter(d=>d&&d.isActive&&this.isInRange(d));let p=this.position.x,a=null;o&&o.length>0?(a=this._findTargetBloon(o,null),a&&a.position&&(p=a.position.x)):window.sceneRef&&window.sceneRef.pathPoints&&window.sceneRef.pathPoints.length>0&&(p=window.sceneRef.pathPoints[Math.floor(Math.random()*window.sceneRef.pathPoints.length)].x+(Math.random()-.5)*60);const h=new g({position:{x:p,y:-100},direction:{x:0,y:1},speed:800,damage:this._headshot&&a&&a.type!=="boss"&&a.constructor.name!=="BossBloon"?this.damage*999:this._headshot?this.damage*10:this.damage,texture:this.projectileTexture,target:a,hitRadius:36,homing:!0,maxHits:this._piercingShot?3:1,showExplosion:!0});h.position={x:p,y:-100},h.sourceTower=this,h.isSniperDrop=!0,h.piercingShot=this._piercingShot||!1;const c=window.sceneRef.add.sprite(p,-100,"sniper_projectile");c.setDisplaySize(13,13),c.setScale(.3),c.setDepth(3001),h.sprite=c,this.projectiles.push(h),window.sceneRef.gameLogic&&Array.isArray(window.sceneRef.gameLogic.projectiles)&&window.sceneRef.gameLogic.projectiles.push(h)}const t=this._pendingDrops.indexOf(n);t!==-1&&this._pendingDrops.splice(t,1)},1e3);this._pendingDrops.push(n)}},50)}_findTargetBloon(e,i){if(!e||e.length===0)return null;const r=e.filter(t=>t&&t.isActive);if(r.length===0)return null;const n=this.targetingPriority||"First";return n==="First"?r.reduce((t,s)=>s.progress>t.progress?s:t,r[0]):n==="Last"?r.reduce((t,s)=>s.progress<t.progress?s:t,r[0]):n==="Strong"?r.reduce((t,s)=>{const o=typeof s.damage=="number"?s.damage:1,p=typeof t.damage=="number"?t.damage:1;return o>p?s:t},r[0]):r.reduce((t,s)=>{const o=Math.hypot(t.position.x-i.x,t.position.y-i.y);return Math.hypot(s.position.x-i.x,s.position.y-i.y)<o?s:t},r[0])}}export{f as SniperTower};
