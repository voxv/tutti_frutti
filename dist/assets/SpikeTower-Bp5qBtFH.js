import{ProjectileTower as S}from"./ProjectileTower-B7NrgRxC.js";import"./index-DYqfCKwm.js";class m extends S{applyUpgrade(e){console.log("[SpikeTower] applyUpgrade called:",{upgradeKey:e,pos:this.position,id:this._debugId,before:this._fatSpikes}),e==="bigger_range"?(this.range+=10,this._placedSprite&&this._placedSprite.towerRange!==void 0&&(this._placedSprite.towerRange=this.range)):e==="even_bigger_range"?(this.range+=10,this._placedSprite&&this._placedSprite.towerRange!==void 0&&(this._placedSprite.towerRange=this.range)):e==="more_spikes"?this._moreSpikes=!0:e==="faster_spikes"?this.fireRate+=.2:e==="super_fast_spikes"?this.fireRate+=.2:e==="fat_spikes"&&(this._fatSpikes=!0),this.upgrades=this.upgrades||[],this.upgrades.push(e),console.log("[SpikeTower] applyUpgrade finished:",{upgradeKey:e,pos:this.position,id:this._debugId,after:this._fatSpikes})}fire(e,n){}static placeOnScene(e,n,a){let o=110,r={};e&&e.towerConfig&&e.towerConfig.spike&&(r={...e.towerConfig.spike},e.towerConfig.spike.range&&(o=e.towerConfig.spike.range));const s=new m({position:{x:n,y:a},range:o,...r}),t=e.add.sprite(n,a,"spike_placed",0).setDisplaySize(64,64).setDepth(1001).setAlpha(1).setInteractive({useHandCursor:!0});return t.anims&&t.anims.stop(),t.setFrame(0),t.towerType="spike",t.towerX=n,t.towerY=a,t.towerRange=o,s._placedSprite=t,s.scene=e,s}constructor(e={}){super({...e,type:"projectile"}),this.lastSpikeTime=0,this.fireCooldown=0,this._spikeShootingDisabled=!0,this._fatSpikes=!1,this.towerType="spike",this._debugId=Math.floor(Math.random()*1e6)}update(e,n,a){if(this._spikeShootingDisabled)return;let o=a;if((!o||!Array.isArray(o)||o.length===0)&&this.scene&&this.scene.pathPoints&&(o=this.scene.pathPoints),!(!o||!Array.isArray(o)||o.length===0)&&!(!this.scene||!this.scene.spline)){if(this.fireCooldown&&this.fireCooldown>0&&(this.fireCooldown-=e),(this.fireCooldown===void 0||this.fireCooldown===0||this.fireCooldown<=0)&&o&&o.length>0&&this.scene&&this.scene.spline){const r=[];for(let t=0;t<=100;t++){const p=t/100,i=this.scene.spline.getPoint(p);if(!i)continue;const c=i.x-this.position.x,f=i.y-this.position.y;Math.sqrt(c*c+f*f)<=this.range&&r.push({x:i.x,y:i.y})}if(r.length>0){const t=this._moreSpikes?2:1;for(let p=0;p<t;p++){let i=r[Math.floor(Math.random()*r.length)];const c=(Math.random()-.5)*12;if(i={x:i.x,y:i.y+c},this.scene&&this.scene.spikeProjectiles&&this.scene.spikeProjectiles.some(h=>{const l=h.x-i.x,d=h.y-i.y;return Math.sqrt(l*l+d*d)<4})){const h=Math.random()*2*Math.PI,l=6+Math.random()*4;i={x:i.x+Math.cos(h)*l,y:i.y+Math.sin(h)*l}}this.throwSpike(i)}if(this.lastSpikeTime=performance.now(),this.fireCooldown=1/(this.fireRate||1),this._placedSprite&&this._placedSprite.anims){const p="spike_tower_idle";this._placedSprite.anims&&this._placedSprite.anims.stop(),this._placedSprite.setFrame(0),this._placedSprite.play(p,!0);const i=this._placedSprite.anims.currentAnim?.frameRate?1e3/this._placedSprite.anims.currentAnim.frameRate*this._placedSprite.anims.currentAnim.frames.length:300;setTimeout(()=>{this._placedSprite&&this._placedSprite.anims&&this._placedSprite.anims.stop(),this._placedSprite&&this._placedSprite.setFrame&&this._placedSprite.setFrame(0)},i)}}}this.fireCooldown&&this.fireCooldown>0&&(this.fireCooldown-=e),super.update(e,n,a)}}throwSpike(e){const n=this.position.x,a=this.position.y,o=e.x,r=e.y,s=this.scene.add.sprite(n,a,"spike_projectile");s.setDepth(2e3);const t=this._fatSpikes?47:24;s.setDisplaySize(t,t),this._fatSpikes&&s.setTint(16711935),s.damage=this.damage,s.active=!1,s.hitRadius=t,s._hasHit=new Set,this._fatSpikes&&(s.remainingPops=2),this.scene.tweens.add({targets:s,x:o,y:r,duration:250,ease:"Quad.easeOut",onComplete:()=>{s.active=!0,this.scene.spikeProjectiles||(this.scene.spikeProjectiles=[]),this.scene.spikeProjectiles.push(s)}})}}export{m as SpikeTower};
